{% extends "base-dashboard.html" %}

{% block title %}Salvate - Dashboard{% endblock %}

{% block content_dashboard %}

    <div class="main-content">
        <div class="header">
            <div class="header-title">Кошелёк</div>
            <div class="action-buttons">
                <button class="btn btn-income">
                    <span class="btn-icon">+</span> Доход
                </button>
                <button class="btn btn-expense">
                    <span class="btn-icon">−</span> Расход
                </button>
            </div>
        </div>

        <div class="card balance-card">
            <div class="percent-change positive" id="incomePercentChange">
                +2.4%
                <div class="arrow-up"><i class="fa-solid fa-square-arrow-up-right"></i></div>
            </div>
            <div class="card-label">Баланс</div>
            <div class="balance-amount">124,500 ₸</div>
        </div>

        <div class="card">
            <div class="cashflow-header">
                <div class="card-label">Денежный поток</div>
                <div class="time-filters">
                    <div class="time-filter active">День</div>
                    <div class="time-filter">Неделя</div>
                    <div class="time-filter">Месяц</div>
                    <div class="time-filter">Год</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="cashflowChart"></canvas>
            </div>
        </div>

        <div class="cards-row">
            <div class="card half-card">
                <div class="card-header-info">
                    <div class="card-label">Доходы</div>
                    <div class="percent-change positive" id="incomePercentChange">
                        +2.4%
                        <div class="arrow-up"><i class="fa-solid fa-square-arrow-up-right"></i></div>
                    </div>
                </div>
                <div class="balance-amount">45,200 ₸</div>
            </div>
            <div class="card half-card">
                 <div class="card-header-info">
                    <div class="card-label">Расходы</div>
                    <div class="percent-change negative" id="expensePercentChange">
                        -1.5%
                        <div class="arrow-down"><i class="fa-solid fa-square-arrow-up-right fa-rotate-90"></i></div>
                    </div>
                </div>
                <div class="balance-amount">32,800 ₸</div>
            </div>
        </div>

        <div class="cards-row">
            <div class="card half-card">
                <div class="card-label">Финансовые цели</div>
                <div class="goal-item">
                    <div>Новый ноутбук</div>
                    <div>65%</div>
                </div>
                <div class="goal-progress">
                    <div class="goal-bar" style="width: 65%"></div>
                </div>

                <div class="goal-item">
                    <div>Отпуск</div>
                    <div>40%</div>
                </div>
                <div class="goal-progress">
                    <div class="goal-bar" style="width: 40%"></div>
                </div>

                <div class="goal-item">
                    <div>Новый телефон</div>
                    <div>85%</div>
                </div>
                <div class="goal-progress">
                    <div class="goal-bar" style="width: 85%"></div>
                </div>
            </div>
            <div class="card half-card">
                <div class="card-label">Сбережения</div>
                <div class="balance-amount">78,300 ₸</div>

                <div class="savings-total">
                    <div class="savings-total-label">Всего отложено</div>
                    <div class="savings-total-amount">245,600 ₸</div>
                    <div class="percent-change positive savings-percent">
                        +12.5%
                        <div class="arrow-up"><i class="fa-solid fa-square-arrow-up-right"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="activity-header">
                <div class="card-label">Недавняя активность</div>
                <div class="show-all">Показать все <span class="arrow-right">›</span></div>
            </div>

            <div class="activity-list">
                <div class="activity-item">
                    <div class="activity-icon positive">+</div>
                    <div class="activity-details">
                        <div class="activity-main">
                            <div class="activity-title">Зарплата</div>
                            <div class="activity-amount positive">+42,000 ₸</div>
                        </div>
                        <div class="activity-subtitle">
                            <div>Основная работа</div>
                            <div class="activity-date">24 сентября</div>
                        </div>
                    </div>
                </div>

                <div class="activity-item">
                    <div class="activity-icon negative">−</div>
                    <div class="activity-details">
                        <div class="activity-main">
                            <div class="activity-title">Продукты</div>
                            <div class="activity-amount negative">-3,450 ₸</div>
                        </div>
                        <div class="activity-subtitle">
                            <div>Супермаркет "Перекрёсток"</div>
                            <div class="activity-date">23 сентября</div>
                        </div>
                    </div>
                </div>

                <div class="activity-item">
                    <div class="activity-icon positive">+</div>
                    <div class="activity-details">
                        <div class="activity-main">
                            <div class="activity-title">Возврат долга</div>
                            <div class="activity-amount positive">+5,000 ₸</div>
                        </div>
                        <div class="activity-subtitle">
                            <div>Друг отдал долг</div>
                            <div class="activity-date">22 сентября</div>
                        </div>
                    </div>
                </div>

                <div class="activity-item">
                    <div class="activity-icon negative">−</div>
                    <div class="activity-details">
                        <div class="activity-main">
                            <div class="activity-title">Кафе</div>
                            <div class="activity-amount negative">-520 ₸</div>
                        </div>
                        <div class="activity-subtitle">
                            <div>Перекус возле университета</div>
                            <div class="activity-date">22 сентября</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_css_dashboard %}

{% endblock %}

{% block extra_js_dashboard %}

<!-- <script>
    // Check if user is logged in
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/auth/login';
    }
    
    // Fetch dashboard stats
    async function fetchStats() {
        try {
            const response = await fetch('/api/dashboard/stats', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('activeSubscriptions').textContent = data.active_subscriptions;
                document.getElementById('totalRevenue').textContent = `$${data.revenue.toFixed(2)}`;
            } else {
                throw new Error('Failed to fetch stats');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
    
    // Fetch recent activity
    async function fetchActivity() {
        try {
            const response = await fetch('/api/dashboard/recent-activity', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // Display recent subscriptions
                const subscriptionsHtml = data.recent_subscriptions.map(sub => `
                    <div class="activity-item">
                        <p class="text-white font-medium">${sub.id}</p>
                        <p>Status: ${sub.status}</p>
                        <p class="text-purple-400">Price: $${sub.price}</p>
                    </div>
                `).join('');
                document.getElementById('recentSubscriptions').innerHTML = subscriptionsHtml || '<p>No recent subscriptions</p>';
                
                // Display recent users
                const usersHtml = data.recent_users.map(user => `
                    <div class="activity-item">
                        <p class="text-white font-medium">${user.email}</p>
                        <p>${user.full_name || user.username}</p>
                    </div>
                `).join('');
                document.getElementById('recentUsers').innerHTML = usersHtml || '<p>No recent users</p>';
            } else {
                throw new Error('Failed to fetch activity');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
    
    // Initial fetch
    fetchStats();
    fetchActivity();
    
    // Refresh data every 30 seconds
    setInterval(() => {
        fetchStats();
        fetchActivity();
    }, 30000);
</script> -->

{% endblock %}